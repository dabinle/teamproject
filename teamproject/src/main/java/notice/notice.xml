<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="notice">

	<select id="list" resultType="board.BoardDTO">
		select * 
		from (
			select rownoticeNum as rn, A.*
			from (
				select noticeNum, writer, subject, noticeDate, hit, (select count(*) from board_comment where board_noticeNum=b.noticeNum) count_comments, noticeFile,filesize,down,group_noticeNum,re_order,re_depth
				from board b
				order by group_noticeNum desc, re_order asc
			) A
		)
		where rn between #{start} and #{end}
	</select>
	
	<select id="count" resultType="int">
		select count(*) from board
	</select>
	
	<select id="check_pwd" resultType="String">
		select passwd from board
		where noticeNum=#{noticeNum} and passwd=#{passwd}
	</select>
	
	<select id="view" resultType="board.BoardDTO">
		select * from board where noticeNum=#{noticeNum}
	</select>
	
	<select id="list_comment" resultType="board.BoardCommentDTO">
		select comment_noticeNum, board_noticeNum, writer, noticeContent, to_char(noticeDate, 'yyyy-mm-dd HH:mi:ss') noticeDate 
		from board_comment
		where board_noticeNum=#{board_noticeNum}
		order by comment_noticeNum
	</select>
	
	<select id="noticeFile" resultType="String">
		select noticeFile from board where noticeNum=#{noticeNum}
	</select>
	
	<select id="search_list" resultType="board.BoardDTO">
		select * 
		from (
			select rownoticeNum as rn, A.*
			from (
				select noticeNum,writer,subject,noticeDate,hit,(select count(*) from board_comment where board_noticeNum=b.noticeNum) count_comments, noticeFile,filesize,down,group_noticeNum,re_order,re_depth
				from board b
				<choose>
					<when test="search_option != 'all' ">
						where ${search_option} like '%' || #{keyword} || '%'
					</when>
					<when test="search_option == 'all' ">
						where writer like '%' || #{keyword} || '%' or subject like '%' || #{keyword} || '%' or noticeContent like '%' || #{keyword} || '%'
					</when>
				</choose>
				order by group_noticeNum desc, re_order asc
			) A
		)
		where rn between #{start} and #{end}
	</select>
	
	<select id="search_count" resultType="int">
		select count(*) from board
		<choose>
			<when test="search_option != 'all' ">
				where ${search_option} like '%' || #{keyword} || '%'
			</when>
			<when test="search_option == 'all' ">
				where writer like '%' || #{keyword} || '%' or subject like '%' || #{keyword} || '%' or noticeContent like '%' || #{keyword} || '%'
			</when>
		</choose>
	</select>
	
	<insert id="insert">
		insert into board (noticeNum,writer,subject,passwd,group_noticeNum,re_order,re_depth,noticeContent,ip,noticeFile,filesize) values ((select nvl(max(noticeNum)+1,1) from board), #{writer}, #{subject}, #{passwd}, (select nvl(max(noticeNum)+1,1) from board), 1,0,#{noticeContent}, #{ip},#{noticeFile},#{filesize})
	</insert>
	
	<insert id="insert_comment">
		insert into board_comment (comment_noticeNum, board_noticeNum, writer, noticeContent) values ((select nvl(max(comment_noticeNum)+1,1) from board_comment), #{board_noticeNum}, #{writer}, #{noticeContent})
	</insert>
	
	<insert id="insert_reply">
		insert into board (noticeNum,writer,subject,passwd,group_noticeNum,re_order,re_depth,noticeContent,ip,noticeFile,filesize) values ((select nvl(max(noticeNum)+1,1) from board), #{writer},#{subject},#{passwd},#{group_noticeNum},#{re_order}, #{re_depth},#{noticeContent},#{ip},#{noticeFile},#{filesize})
	</insert>
	
	<update id="plus_hit">
		update board set hit=hit+1 where noticeNum=#{noticeNum}
	</update>
	
	<update id="update">
		update board set writer=#{writer}, subject=#{subject}, noticeContent=#{noticeContent}, noticeFile=#{noticeFile}, filesize=#{filesize}, down=#{down} where noticeNum=#{noticeNum}
	</update>
	
	<update id="update_order">
		update board set re_order=re_order + 1 where group_noticeNum=#{group_noticeNum} and re_order >= #{re_order}
	</update>
	
	<update id="plus_down">
		update board set down=down+1 where noticeNum=#{noticeNum}
	</update>
	
	<delete id="delete">
		delete from board where noticeNum=#{noticeNum}
	</delete>

	</mapper>